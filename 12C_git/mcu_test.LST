C51 COMPILER V9.03   MCU_TEST                                                              05/20/2015 11:45:23 PAGE 1   


C51 COMPILER V9.03, COMPILATION OF MODULE MCU_TEST
OBJECT MODULE PLACED IN .\output\mcu_test.obj
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE mcu_test.c BROWSE DEBUG OBJECTEXTEND OBJECT(.\output\mcu_test.obj)

line level    source

   1          #include        <STC12C5A60S2.H>
   2          #include        <stdlib.h>
   3          #include        <stdio.h>
   4          #include        <string.h>
   5          
   6          #define uchar unsigned char
   7          #define uint unsigned int   
   8          /************************************宏定义************************************/
   9          #define VELOCITY_30C    3495       //30摄氏度时的声速，声速V= 331.5 + 0.6*温度； 
  10          #define VELOCITY_23C    3453       //23摄氏度时的声速，声速V= 331.5 + 0.6*温度； 
  11          
  12          /************************************位定义************************************/
  13          sbit INPUT  = P2^6;                //回声接收端口,
  14          sbit OUTPUT = P2^7;                //超声触发端口
  15          
  16          /********************************定义变量和数组********************************/
  17          long int distance=0;               //距离变量
  18          uchar count;
  19          unsigned char a[4];
  20          
  21          /***********************************函数声明***********************************/
  22          void PWMInit();
  23          void PWMInit_B();
  24          
  25          
  26          
  27          
  28          void UART1_Send_Byte(unsigned char ddata) 
  29          {           
  30   1              SBUF = ddata;  //写入要发送的字符
  31   1              while(!TI);    //等待发送完毕
  32   1              TI = 0;        //清发送标志   
  33   1      }
  34          
  35          void UART1_Send_String(unsigned char *str)
  36          {
  37   1              while(*str!='\0')
  38   1              {
  39   2                      UART1_Send_Byte(*str++);        
  40   2              }
  41   1      } 
  42          
  43          void UartInit(void)             //9600bps@11.0592MHz
  44          {
  45   1              PCON=0x00;
  46   1              SCON = 0x50;            //8位数据,可变波特率
  47   1              TMOD = 0x21;                    //设定定时器1为16位自动重装方式
  48   1              TL1 = 0xfa;                     //设定定时初值
  49   1              TH1 = 0xfa;                     //设定定时初值
  50   1              TR1 = 1;                //启动定时器1
  51   1              EA=1;                   //开总中断
  52   1      
  53   1      }
  54          /**************************************/
  55          void show()
C51 COMPILER V9.03   MCU_TEST                                                              05/20/2015 11:45:23 PAGE 2   

  56          {
  57   1              int ge,shi,bai;
  58   1              ge = distance%10;
  59   1              shi = distance/10%10;
  60   1              bai = distance/100%10;
  61   1              a[0] = distance/1000 +'0';
  62   1              a[1] = bai + '0';
  63   1              a[2] = shi + '0';
  64   1              a[3] = '\0';
  65   1      }
  66          /******************************************************************************/
  67          /* 函数名称  : Delay_xMs                                                      */
  68          /* 函数描述  : 延时函数                                                       */
  69          /* 输入参数  : x                                                              */
  70          /* 参数描述  : 延时时间                                                       */
  71          /* 返回值    : 无                                                             */
  72          /******************************************************************************/
  73          void Delay_xMs(unsigned int x)
  74          {
  75   1          unsigned int i,j;
  76   1          for(i = 0;i < x;i++ )
  77   1          {
  78   2              for(j = 0;j < 3;j++ )
  79   2              {
  80   3                  ;
  81   3              }
  82   2          }
  83   1      }       
  84          /******************************************************************************/
  85          /* 函数名称  : delayt                                                         */
  86          /* 函数描述  : 延时函数                                                       */
  87          /* 输入参数  : x                                                              */
  88          /* 参数描述  : 延时时间数据                                                   */
  89          /* 返回值    : 无                                                             */
  90          /******************************************************************************/        
  91          void delayt(uint x)
  92          {
  93   1          uchar j;
  94   1          while(x-- > 0)
  95   1          {
  96   2                  for(j = 0;j < 125;j++)
  97   2              {
  98   3                  ;
  99   3              }
 100   2          }
 101   1      }
 102          /******************************************************************************/
 103          /* 函数名称  : Init_MCU                                                       */
 104          /* 函数描述  : 初始化单片机函数                                               */
 105          /* 输入参数  : 无                                                             */
 106          /* 参数描述  : 无                                                             */
 107          /* 返回值    : 无                                                             */
 108          /******************************************************************************/
 109          void Init_MCU(void)
 110          {
 111   1              
 112   1              //TMOD = 0x01;    //定时器0初始化,设置为16位自动重装模式        与串口的TMOD配置重叠了
 113   1              
 114   1              TL0 = 0xcd;
 115   1              TH0 = 0xf8;           //1ms
 116   1          ET0 = 1;          //开定时器0
 117   1              EA = 1;               //总中断使能
C51 COMPILER V9.03   MCU_TEST                                                              05/20/2015 11:45:23 PAGE 3   

 118   1      }
 119          
 120          /******************************************************************************/
 121          /* 函数名称  : Init_Parameter                                                 */
 122          /* 函数描述  : 初始化参数和IO口函数                                           */
 123          /* 输入参数  : 无                                                             */
 124          /* 参数描述  : 无                                                             */
 125          /* 返回值    : 无                                                             */
 126          /******************************************************************************/
 127          void Init_Parameter(void)
 128          {
 129   1               OUTPUT =1;
 130   1               INPUT = 1;
 131   1               count = 0;
 132   1               distance = 0;
 133   1      }
 134          
 135          /******************************************************************************/
 136          /* 函数名称  : Trig_SuperSonic                                                */
 137          /* 函数描述  : 发出声波函数                                                   */
 138          /* 输入参数  : 无                                                             */
 139          /* 参数描述  : 无                                                             */
 140          /* 返回值    : 无                                                             */
 141          /******************************************************************************/
 142          void Trig_SuperSonic(void)//出发声波
 143          {
 144   1               OUTPUT = 1;
 145   1               delayt(3);
 146   1               OUTPUT = 0;
 147   1      }
 148          
 149          /******************************************************************************/
 150          /* 函数名称  : Measure_Distance                                               */
 151          /* 函数描述  : 计算距离函数                                                   */
 152          /* 输入参数  : 无                                                             */
 153          /* 参数描述  : 无                                                             */
 154          /* 返回值    : 无                                                             */
 155          /******************************************************************************/
 156          void Measure_Distance(void)
 157          {
 158   1              uchar l;
 159   1              uint h,y;
 160   1              uchar temp[5];
 161   1              TR0 = 1;
 162   1              while(INPUT)
 163   1              {
 164   2          ;
 165   2              }       
 166   1              TR0 = 0;
 167   1              l = TL0;
 168   1              h = TH0;
 169   1              y = (h << 8) + l;
 170   1              y = y - 0xf8cd;//us部分
 171   1              distance = y + 1000 * count;//计算总时间
 172   1              TL0 = 0xcd;
 173   1              TH0 = 0xf8;
 174   1              delayt(30);
 175   1              distance = VELOCITY_30C * distance / 20000;
 176   1              memset(temp,0,sizeof(temp));
 177   1              sprintf(temp,"%d",distance);
 178   1              //UART1_Send_String("distance:");
 179   1      //      UART1_Send_String(temp);
C51 COMPILER V9.03   MCU_TEST                                                              05/20/2015 11:45:23 PAGE 4   

 180   1      }
 181          
 182          /******************************************************************************/
 183          /* 函数名称  : main                                                           */
 184          /* 函数描述  : 主函数                                                         */
 185          /* 输入参数  : 无                                                             */
 186          /* 参数描述  : 无                                                             */
 187          /* 返回值    : 无                                                             */
 188          /******************************************************************************/                                        
 189          void main(void)
 190          {
 191   1              Init_MCU();
 192   1              Init_Parameter();
 193   1              UartInit();
 194   1              Delay_xMs(30000);
 195   1              while(1)
 196   1              {
 197   2                       Trig_SuperSonic();         //触发超声波发射
 198   2                       while(INPUT == 0)          //等待回声
 199   2              {
 200   3                      ;
 201   3              }
 202   2                       Measure_Distance();        //计算脉宽并转换为距离
 203   2                       show();
 204   2                       UART1_Send_String("distance = ");
 205   2                       UART1_Send_String(a);
 206   2                       UART1_Send_String("\n");
 207   2                       Init_Parameter();          // 参数重新初始化
 208   2                       delayt(10);               //延时，两次发射之间要至少有10ms间隔
 209   2               }      
 210   1      }
 211          
 212          /******************************************************************************/
 213          /* 函数名称  : timer0                                                         */
 214          /* 函数描述  : T0中断处理函数，                                                 */
 215          /* 输入参数  : 无                                                             */
 216          /* 参数描述  : 无                                                             */
 217          /* 返回值    : 无                                                             */
 218          /******************************************************************************/
 219          void timer0 (void) interrupt 1
 220          {
 221   1              TF0 = 0;
 222   1              TL0 = 0xcd;
 223   1              TH0 = 0xf8;
 224   1              count++;
 225   1              if(count == 36)//超声波回声脉宽最多18ms
 226   1              {
 227   2                      TR0 =0;
 228   2                      TL0 = 0xcd;
 229   2                      TH0 = 0xf8;
 230   2                      count = 0;
 231   2              }
 232   1      }
 233          /******************************************************************************/
 234          
 235          
 236          
 237          
 238          
 239          


C51 COMPILER V9.03   MCU_TEST                                                              05/20/2015 11:45:23 PAGE 5   

MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    547    ----
   CONSTANT SIZE    =     17    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      9      14
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
