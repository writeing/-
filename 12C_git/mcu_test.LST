C51 COMPILER V9.03   MCU_TEST                                                              05/20/2015 13:43:57 PAGE 1   


C51 COMPILER V9.03, COMPILATION OF MODULE MCU_TEST
OBJECT MODULE PLACED IN .\output\mcu_test.obj
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE mcu_test.c BROWSE DEBUG OBJECTEXTEND OBJECT(.\output\mcu_test.obj)

line level    source

   1          /******************************************************
   2          //5-20:
   3          (1)增加了超声波的测量.
   4          (2)增加了PWM调制，可以改变电压，于LM298一起
   5          
   6          *******************************************************/
   7          #include        <config.h>
   8          #include        <PWM.h>
   9          
  10           
  11          /************************************宏定义************************************/
  12          #define VELOCITY_30C    3495       //30摄氏度时的声速，声速V= 331.5 + 0.6*温度； 
  13          #define VELOCITY_23C    3453       //23摄氏度时的声速，声速V= 331.5 + 0.6*温度； 
  14          
  15          /************************************位定义************************************/
  16          sbit INPUT  = P2^6;                //回声接收端口,
  17          sbit OUTPUT = P2^7;                //超声触发端口
  18          
  19          /********************************定义变量和数组********************************/
  20          long int distance=0;               //距离变量
  21          uchar count;
  22          unsigned char a[4];
  23          
  24          
  25          /**************************************/
  26          void show()
  27          {
  28   1              int ge,shi,bai;
  29   1              ge = distance%10;
  30   1              shi = distance/10%10;
  31   1              bai = distance/100%10;
  32   1              a[0] = distance/1000 +'0';
  33   1              a[1] = bai + '0';
  34   1              a[2] = shi + '0';
  35   1              a[3] = '\0';
  36   1      }
  37          /******************************************************************************/
  38          /* 函数名称  : Delay_xMs                                                      */
  39          /* 函数描述  : 延时函数                                                       */
  40          /* 输入参数  : x                                                              */
  41          /* 参数描述  : 延时时间                                                       */
  42          /* 返回值    : 无                                                             */
  43          /******************************************************************************/
  44          void Delay_xMs(unsigned int x)
  45          {
  46   1          unsigned int i,j;
  47   1          for(i = 0;i < x;i++ )
  48   1          {
  49   2              for(j = 0;j < 3;j++ )
  50   2              {
  51   3                  ;
  52   3              }
  53   2          }
  54   1      }       
  55          /******************************************************************************/
C51 COMPILER V9.03   MCU_TEST                                                              05/20/2015 13:43:57 PAGE 2   

  56          /* 函数名称  : delayt                                                         */
  57          /* 函数描述  : 延时函数                                                       */
  58          /* 输入参数  : x                                                              */
  59          /* 参数描述  : 延时时间数据                                                   */
  60          /* 返回值    : 无                                                             */
  61          /******************************************************************************/        
  62          void delayt(uint x)
  63          {
  64   1          uchar j;
  65   1          while(x-- > 0)
  66   1          {
  67   2                  for(j = 0;j < 125;j++)
  68   2              {
  69   3                  ;
  70   3              }
  71   2          }
  72   1      }
  73          /******************************************************************************/
  74          /* 函数名称  : Init_MCU                                                       */
  75          /* 函数描述  : 初始化单片机函数                                               */
  76          /* 输入参数  : 无                                                             */
  77          /* 参数描述  : 无                                                             */
  78          /* 返回值    : 无                                                             */
  79          /******************************************************************************/
  80          void Init_MCU(void)
  81          {
  82   1              
  83   1              //TMOD = 0x01;    //定时器0初始化,设置为16位自动重装模式        与串口的TMOD配置重叠了
  84   1              
  85   1              TL0 = 0xcd;
  86   1              TH0 = 0xf8;           //1ms
  87   1          ET0 = 1;          //开定时器0
  88   1              EA = 1;               //总中断使能
  89   1      }
  90          
  91          /******************************************************************************/
  92          /* 函数名称  : Init_Parameter                                                 */
  93          /* 函数描述  : 初始化参数和IO口函数                                           */
  94          /* 输入参数  : 无                                                             */
  95          /* 参数描述  : 无                                                             */
  96          /* 返回值    : 无                                                             */
  97          /******************************************************************************/
  98          void Init_Parameter(void)
  99          {
 100   1               OUTPUT =1;
 101   1               INPUT = 1;
 102   1               count = 0;
 103   1               distance = 0;
 104   1      }
 105          
 106          /******************************************************************************/
 107          /* 函数名称  : Trig_SuperSonic                                                */
 108          /* 函数描述  : 发出声波函数                                                   */
 109          /* 输入参数  : 无                                                             */
 110          /* 参数描述  : 无                                                             */
 111          /* 返回值    : 无                                                             */
 112          /******************************************************************************/
 113          void Trig_SuperSonic(void)//出发声波
 114          {
 115   1               OUTPUT = 1;
 116   1               delayt(3);
 117   1               OUTPUT = 0;
C51 COMPILER V9.03   MCU_TEST                                                              05/20/2015 13:43:57 PAGE 3   

 118   1      }
 119          
 120          /******************************************************************************/
 121          /* 函数名称  : Measure_Distance                                               */
 122          /* 函数描述  : 计算距离函数                                                   */
 123          /* 输入参数  : 无                                                             */
 124          /* 参数描述  : 无                                                             */
 125          /* 返回值    : 无                                                             */
 126          /******************************************************************************/
 127          void Measure_Distance(void)
 128          {
 129   1              uchar l;
 130   1              uint h,y;
 131   1              TR0 = 1;
 132   1              while(INPUT)
 133   1              {
 134   2          ;
 135   2              }       
 136   1              TR0 = 0;
 137   1              l = TL0;
 138   1              h = TH0;
 139   1              y = (h << 8) + l;
 140   1              y = y - 0xf8cd;//us部分
 141   1              distance = y + 1000 * count;//计算总时间
 142   1              TL0 = 0xcd;
 143   1              TH0 = 0xf8;
 144   1              delayt(30);
 145   1              distance = VELOCITY_30C * distance / 20000;
 146   1      }
 147          
 148          /******************************************************************************/
 149          /* 函数名称  : main                                                           */
 150          /* 函数描述  : 主函数                                                         */
 151          /* 输入参数  : 无                                                             */
 152          /* 参数描述  : 无                                                             */
 153          /* 返回值    : 无                                                             */
 154          /******************************************************************************/                                        
 155          void main(void)
 156          {
 157   1              Init_MCU();
 158   1              Init_Parameter();
 159   1              UartInit();
 160   1              Delay_xMs(30000);
 161   1              while(1)
 162   1              {
 163   2                       Trig_SuperSonic();         //触发超声波发射
 164   2                       while(INPUT == 0)          //等待回声
 165   2              {
 166   3                      ;
 167   3              }
 168   2                       Measure_Distance();        //计算脉宽并转换为距离
 169   2                       show();
 170   2                       UART1_Send_String("distance = ");
 171   2                       UART1_Send_String(a);
 172   2                       UART1_Send_String("\n");
 173   2                       Init_Parameter();          // 参数重新初始化
 174   2                       delayt(10);               //延时，两次发射之间要至少有10ms间隔
 175   2               }      
 176   1      }
 177          
 178          /******************************************************************************/
 179          /* 函数名称  : timer0                                                         */
C51 COMPILER V9.03   MCU_TEST                                                              05/20/2015 13:43:57 PAGE 4   

 180          /* 函数描述  : T0中断处理函数，                                                 */
 181          /* 输入参数  : 无                                                             */
 182          /* 参数描述  : 无                                                             */
 183          /* 返回值    : 无                                                             */
 184          /******************************************************************************/
 185          void timer0 (void) interrupt 1
 186          {
 187   1              TF0 = 0;
 188   1              TL0 = 0xcd;
 189   1              TH0 = 0xf8;
 190   1              count++;
 191   1              if(count == 36)//超声波回声脉宽最多18ms
 192   1              {
 193   2                      TR0 =0;
 194   2                      TL0 = 0xcd;
 195   2                      TH0 = 0xf8;
 196   2                      count = 0;
 197   2              }
 198   1      }
 199          /******************************************************************************/
 200          
 201          
 202          
 203          
 204          
 205          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    438    ----
   CONSTANT SIZE    =     14    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      9       6
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
