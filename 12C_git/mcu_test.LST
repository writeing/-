C51 COMPILER V9.03   MCU_TEST                                                              07/24/2015 19:20:44 PAGE 1   


C51 COMPILER V9.03, COMPILATION OF MODULE MCU_TEST
OBJECT MODULE PLACED IN .\output\mcu_test.obj
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE mcu_test.c BROWSE DEBUG OBJECTEXTEND OBJECT(.\output\mcu_test.obj)

line level    source

   1          /******************************************************
   2          //5-20:
   3          (1)增加了超声波的测量.
   4          (2)增加了PWM调制，可以改变电压，于LM298一起
   5          //5-21：
   6          (1)去掉PWM用定时器1控制LM298电压输出
   7          
   8          *******************************************************/
   9          #include        <config.h>
  10          #include        <PWM.h>
  11           
  12          /************************************宏定义************************************/
  13          #define VELOCITY_30C    3495       //30摄氏度时的声速，声速V= 331.5 + 0.6*温度； 
  14          #define VELOCITY_23C    3453       //23摄氏度时的声速，声速V= 331.5 + 0.6*温度； 
  15          
  16          /************************************位定义************************************/
  17          sbit INPUT  = P2^6;                //回声接收端口,
  18          sbit OUTPUT = P2^7;                //超声触发端口
  19          sbit led = P4^4;
  20          /********************************定义变量和数组********************************/
  21          long int distance=0;               //距离变量
  22          uint count=0;
  23          uint DPWM=1;
  24          uchar TPWM=0;
  25          unsigned char a[4];
  26          uint DArray[10];
  27          uint Dflag=0;
  28          
  29          /**************************************/
  30          void show()
  31          {
  32   1              int ge,shi,bai;
  33   1              ge = distance%10;
  34   1              shi = distance/10%10;
  35   1              bai = distance/100%10;
  36   1              a[0] = distance/1000 +'0';
  37   1              a[1] = bai + '0';
  38   1              a[2] = shi + '0';
  39   1              a[3] = '\0';
  40   1      }
  41          /******************************************************************************/
  42          /* 函数名称  : Delay_xMs                                                      */
  43          /* 函数描述  : 延时函数                                                       */
  44          /* 输入参数  : x                                                              */
  45          /* 参数描述  : 延时时间                                                       */
  46          /* 返回值    : 无                                                             */
  47          /******************************************************************************/
  48          void Delay_xMs(unsigned int x)
  49          {
  50   1          unsigned int i,j;
  51   1          for(i = 0;i < x;i++ )
  52   1          {
  53   2              for(j = 0;j < 3;j++ )
  54   2              {
  55   3                  ;
C51 COMPILER V9.03   MCU_TEST                                                              07/24/2015 19:20:44 PAGE 2   

  56   3              }
  57   2          }
  58   1      }       
  59          /******************************************************************************/
  60          /* 函数名称  : delayt                                                         */
  61          /* 函数描述  : 延时函数                                                       */
  62          /* 输入参数  : x                                                              */
  63          /* 参数描述  : 延时时间数据                                                   */
  64          /* 返回值    : 无                                                             */
  65          /******************************************************************************/        
  66          void delayt(uint x)
  67          {
  68   1          uchar j;
  69   1          while(x-- > 0)
  70   1          {
  71   2                  for(j = 0;j < 125;j++)
  72   2              {
  73   3                  ;
  74   3              }
  75   2          }
  76   1      }
  77          /******************************************************************************/
  78          /* 函数名称  : Init_MCU                                                       */
  79          /* 函数描述  : 初始化单片机函数                                               */
  80          /* 输入参数  : 无                                                             */
  81          /* 参数描述  : 无                                                             */
  82          /* 返回值    : 无                                                             */
  83          /******************************************************************************/
  84          void Init_MCU(void)
  85          {
  86   1              
  87   1              //TMOD = 0x01;    //定时器0初始化,设置为16位自动重装模式        与串口的TMOD配置重叠了  
  88   1              TL0 = 0xcd;
  89   1              TH0 = 0xf8;           //1ms
  90   1          ET0 = 1;          //开定时器0
  91   1              EA = 1;               //总中断使能
  92   1      }
  93          
  94          /******************************************************************************/
  95          /* 函数名称  : Init_Parameter                                                 */
  96          /* 函数描述  : 初始化参数和IO口函数                                           */
  97          /* 输入参数  : 无                                                             */
  98          /* 参数描述  : 无                                                             */
  99          /* 返回值    : 无                                                             */
 100          /******************************************************************************/
 101          void Init_Parameter(void)
 102          {
 103   1               OUTPUT =1;
 104   1               INPUT = 1;
 105   1               count = 0;
 106   1               distance = 0;
 107   1      }
 108          
 109          /******************************************************************************/
 110          /* 函数名称  : Trig_SuperSonic                                                */
 111          /* 函数描述  : 发出声波函数                                                   */
 112          /* 输入参数  : 无                                                             */
 113          /* 参数描述  : 无                                                             */
 114          /* 返回值    : 无                                                             */
 115          /******************************************************************************/
 116          void Trig_SuperSonic(void)//出发声波
 117          {
C51 COMPILER V9.03   MCU_TEST                                                              07/24/2015 19:20:44 PAGE 3   

 118   1               OUTPUT = 1;
 119   1               delayt(3);
 120   1               OUTPUT = 0;
 121   1      }
 122          
 123          /******************************************************************************/
 124          /* 函数名称  : Measure_Distance                                               */
 125          /* 函数描述  : 计算距离函数                                                   */
 126          /* 输入参数  : 无                                                             */
 127          /* 参数描述  : 无                                                             */
 128          /* 返回值    : 无                                                             */
 129          /******************************************************************************/
 130          void Measure_Distance(void)
 131          {
 132   1              uchar l;
 133   1              uint h,y;
 134   1              TR0 = 1;
 135   1              while(INPUT)
 136   1              {
 137   2          ;
 138   2              }       
 139   1              TR0 = 0;
 140   1              l = TL0;
 141   1              h = TH0;
 142   1              y = (h << 8) + l;
 143   1              y = y - 0xf8cd;//us部分
 144   1              distance = y + 1000 * count;//计算总时间
 145   1              TL0 = 0xcd;
 146   1              TH0 = 0xf8;
 147   1              delayt(30);
 148   1              distance = VELOCITY_30C * distance / 20000;
 149   1      }
 150          
 151          /******************************************************************************/
 152          /* 函数名称  : main                                                           */
 153          /* 函数描述  : 主函数                                                         */
 154          /* 输入参数  : 无                                                             */
 155          /* 参数描述  : 无                                                             */
 156          /* 返回值    : 无                                                             */
 157          /******************************************************************************/                                        
 158          void main(void)
 159          {
 160   1              int Dtemp=0,i;
 161   1              char buff[10];
 162   1              Init_MCU();
 163   1              UartInit();
 164   1              PWMInit();
 165   1              Delay_xMs(30000);
 166   1              P4SW=0x70;
 167   1              P4 = 0;
 168   1              TR0 = 1;
 169   1              UART1_Send_String("bbbbb"); 
 170   1              while(1)
 171   1              {
 172   2                      if(CCAP0H>220)
 173   2                      {
 174   3                              CCAP0H = 0;
 175   3                      }
 176   2                      if(CCAP0L>220)
 177   2                      {
 178   3                              CCAP0L = 0;
 179   3                              sprintf(buff,"%d",CCAP0H);
C51 COMPILER V9.03   MCU_TEST                                                              07/24/2015 19:20:44 PAGE 4   

 180   3                              UART1_Send_String(buff);
 181   3                      }               
 182   2                      
 183   2              }       
 184   1      }
*** WARNING C280 IN LINE 160 OF mcu_test.c: 'i': unreferenced local variable
 185          
 186          /******************************************************************************/
 187          /* 函数名称  : timer0                                                         */
 188          /* 函数描述  : T0中断处理函数，                                                 */
 189          /* 输入参数  : 无                                                             */
 190          /* 参数描述  : 无                                                             */
 191          /* 返回值    : 无                                                             */
 192          /******************************************************************************/
 193          void timer0 (void) interrupt 1
 194          {
 195   1              TF0 = 0;
 196   1              TL0 = 0xcd;
 197   1              TH0 = 0xf8;
 198   1              count++;
 199   1              led = 0;
 200   1              if(count == 1000)//超声波回声脉宽最多18ms
 201   1              {
 202   2                      led = 1;
 203   2                      CCAP0L+=10;
 204   2                      CCAP0H+=10;
 205   2                      count = 0;
 206   2              }
 207   1      }
 208          /******************************************************************************/
 209          
 210          /******************************************************************************/
 211          /* 函数名称  : timer1                                                         */
 212          /* 函数描述  : T1中断处理函数，                                                 */
 213          /* 输入参数  : 无                                                             */
 214          /* 参数描述  : 无                                                             */
 215          /* 返回值    : 无                                                             */
 216          /******************************************************************************/
 217          void timer1 (void) interrupt 3
 218          {
 219   1              TF1 = 0;        
 220   1              DPWM++;
 221   1              led = 0;
 222   1              if(DPWM > 1000)
 223   1              { 
 224   2              }               
 225   1      }
 226          /******************************************************************************/
 227          
 228          
 229          
 230          
 231          
 232          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    499    ----
   CONSTANT SIZE    =      9    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     35      20
C51 COMPILER V9.03   MCU_TEST                                                              07/24/2015 19:20:44 PAGE 5   

   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
