C51 COMPILER V9.03   MCU_TEST                                                              05/20/2015 17:32:41 PAGE 1   


C51 COMPILER V9.03, COMPILATION OF MODULE MCU_TEST
OBJECT MODULE PLACED IN .\output\mcu_test.obj
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE mcu_test.c BROWSE DEBUG OBJECTEXTEND OBJECT(.\output\mcu_test.obj)

line level    source

   1          /******************************************************
   2          //5-20:
   3          (1)增加了超声波的测量.
   4          (2)增加了PWM调制，可以改变电压，于LM298一起
   5          
   6          *******************************************************/
   7          #include        <config.h>
   8          #include        <PWM.h>
   9           
  10          /************************************宏定义************************************/
  11          #define VELOCITY_30C    3495       //30摄氏度时的声速，声速V= 331.5 + 0.6*温度； 
  12          #define VELOCITY_23C    3453       //23摄氏度时的声速，声速V= 331.5 + 0.6*温度； 
  13          
  14          /************************************位定义************************************/
  15          sbit INPUT  = P2^6;                //回声接收端口,
  16          sbit OUTPUT = P2^7;                //超声触发端口
  17          
  18          /********************************定义变量和数组********************************/
  19          long int distance=0;               //距离变量
  20          uchar count;
  21          int DPWM=1;
  22          int TPWM=0;
  23          unsigned char a[4];
  24          uint DArray[10];
  25          uint Dflag=0;
  26          
  27          /**************************************/
  28          void show()
  29          {
  30   1              int ge,shi,bai;
  31   1              ge = distance%10;
  32   1              shi = distance/10%10;
  33   1              bai = distance/100%10;
  34   1              a[0] = distance/1000 +'0';
  35   1              a[1] = bai + '0';
  36   1              a[2] = shi + '0';
  37   1              a[3] = '\0';
  38   1      }
  39          /******************************************************************************/
  40          /* 函数名称  : Delay_xMs                                                      */
  41          /* 函数描述  : 延时函数                                                       */
  42          /* 输入参数  : x                                                              */
  43          /* 参数描述  : 延时时间                                                       */
  44          /* 返回值    : 无                                                             */
  45          /******************************************************************************/
  46          void Delay_xMs(unsigned int x)
  47          {
  48   1          unsigned int i,j;
  49   1          for(i = 0;i < x;i++ )
  50   1          {
  51   2              for(j = 0;j < 3;j++ )
  52   2              {
  53   3                  ;
  54   3              }
  55   2          }
C51 COMPILER V9.03   MCU_TEST                                                              05/20/2015 17:32:41 PAGE 2   

  56   1      }       
  57          /******************************************************************************/
  58          /* 函数名称  : delayt                                                         */
  59          /* 函数描述  : 延时函数                                                       */
  60          /* 输入参数  : x                                                              */
  61          /* 参数描述  : 延时时间数据                                                   */
  62          /* 返回值    : 无                                                             */
  63          /******************************************************************************/        
  64          void delayt(uint x)
  65          {
  66   1          uchar j;
  67   1          while(x-- > 0)
  68   1          {
  69   2                  for(j = 0;j < 125;j++)
  70   2              {
  71   3                  ;
  72   3              }
  73   2          }
  74   1      }
  75          /******************************************************************************/
  76          /* 函数名称  : Init_MCU                                                       */
  77          /* 函数描述  : 初始化单片机函数                                               */
  78          /* 输入参数  : 无                                                             */
  79          /* 参数描述  : 无                                                             */
  80          /* 返回值    : 无                                                             */
  81          /******************************************************************************/
  82          void Init_MCU(void)
  83          {
  84   1              
  85   1              //TMOD = 0x01;    //定时器0初始化,设置为16位自动重装模式        与串口的TMOD配置重叠了
  86   1              
  87   1              TL0 = 0xcd;
  88   1              TH0 = 0xf8;           //1ms
  89   1          ET0 = 1;          //开定时器0
  90   1              EA = 1;               //总中断使能
  91   1      }
  92          
  93          /******************************************************************************/
  94          /* 函数名称  : Init_Parameter                                                 */
  95          /* 函数描述  : 初始化参数和IO口函数                                           */
  96          /* 输入参数  : 无                                                             */
  97          /* 参数描述  : 无                                                             */
  98          /* 返回值    : 无                                                             */
  99          /******************************************************************************/
 100          void Init_Parameter(void)
 101          {
 102   1               OUTPUT =1;
 103   1               INPUT = 1;
 104   1               count = 0;
 105   1               distance = 0;
 106   1      }
 107          
 108          /******************************************************************************/
 109          /* 函数名称  : Trig_SuperSonic                                                */
 110          /* 函数描述  : 发出声波函数                                                   */
 111          /* 输入参数  : 无                                                             */
 112          /* 参数描述  : 无                                                             */
 113          /* 返回值    : 无                                                             */
 114          /******************************************************************************/
 115          void Trig_SuperSonic(void)//出发声波
 116          {
 117   1               OUTPUT = 1;
C51 COMPILER V9.03   MCU_TEST                                                              05/20/2015 17:32:41 PAGE 3   

 118   1               delayt(3);
 119   1               OUTPUT = 0;
 120   1      }
 121          
 122          /******************************************************************************/
 123          /* 函数名称  : Measure_Distance                                               */
 124          /* 函数描述  : 计算距离函数                                                   */
 125          /* 输入参数  : 无                                                             */
 126          /* 参数描述  : 无                                                             */
 127          /* 返回值    : 无                                                             */
 128          /******************************************************************************/
 129          void Measure_Distance(void)
 130          {
 131   1              uchar l;
 132   1              uint h,y;
 133   1              TR0 = 1;
 134   1              while(INPUT)
 135   1              {
 136   2          ;
 137   2              }       
 138   1              TR0 = 0;
 139   1              l = TL0;
 140   1              h = TH0;
 141   1              y = (h << 8) + l;
 142   1              y = y - 0xf8cd;//us部分
 143   1              distance = y + 1000 * count;//计算总时间
 144   1              TL0 = 0xcd;
 145   1              TH0 = 0xf8;
 146   1              delayt(30);
 147   1              distance = VELOCITY_30C * distance / 20000;
 148   1      }
 149          
 150          /******************************************************************************/
 151          /* 函数名称  : main                                                           */
 152          /* 函数描述  : 主函数                                                         */
 153          /* 输入参数  : 无                                                             */
 154          /* 参数描述  : 无                                                             */
 155          /* 返回值    : 无                                                             */
 156          /******************************************************************************/                                        
 157          void main(void)
 158          {
 159   1              int Dtemp=0,i;
 160   1              Init_MCU();
 161   1              Init_Parameter();
 162   1              UartInit();
 163   1      //      PWMInit();
 164   1              Delay_xMs(30000);
 165   1              while(1)
 166   1              {
 167   2                       
 168   2                       Trig_SuperSonic();         //触发超声波发射
 169   2                       while(INPUT == 0)          //等待回声
 170   2              {
 171   3                      ;
 172   3              }
 173   2                       Measure_Distance();        //计算脉宽并转换为距离
 174   2                       DArray[Dflag++] = distance;
 175   2                       delayt(10000);               //延时，两次发射之间要至少有10ms间隔
 176   2              //       addPWM(30);
 177   2                       if(Dflag==10)
 178   2                       {              
 179   3                       //      reducePWM(250);
C51 COMPILER V9.03   MCU_TEST                                                              05/20/2015 17:32:41 PAGE 4   

 180   3                               TPWM = (TPWM+5)%30;                             
 181   3                               distance = 0; //清零，然后当做平均值
 182   3                               Dflag = 0;     //记住有多少个数据被相加了
 183   3                               for(i=0;i<10;i++)
 184   3                               {
 185   4                                      distance+=DArray[i];                    
 186   4                               }
 187   3                               distance/=10;            
 188   3                               if(distance>40)
 189   3                               {
 190   4                                      Dtemp = distance;
 191   4                               //     setPWM(2);      
 192   4                               }
 193   3                               else
 194   3                               {
 195   4                                      if(distance>10&&distance<40)
 196   4                                      {
 197   5                                      //      setPWM(1);      
 198   5                                      }                       
 199   4                               }      
 200   3                               show();
 201   3                               UART1_Send_String("distance = ");
 202   3                               UART1_Send_String(a);
 203   3                               UART1_Send_String("\n");
 204   3                       }//判断10次接受完成
 205   2                       Init_Parameter();          // 参数重新初始化
 206   2                       
 207   2               }      
 208   1      }
 209          
 210          /******************************************************************************/
 211          /* 函数名称  : timer0                                                         */
 212          /* 函数描述  : T0中断处理函数，                                                 */
 213          /* 输入参数  : 无                                                             */
 214          /* 参数描述  : 无                                                             */
 215          /* 返回值    : 无                                                             */
 216          /******************************************************************************/
 217          void timer0 (void) interrupt 1
 218          {
 219   1              TF0 = 0;
 220   1              TL0 = 0xcd;
 221   1              TH0 = 0xf8;
 222   1              count++;        
 223   1              DPWM++;
 224   1              PWM=0;
 225   1              if(DPWM == TPWM)
 226   1              {
 227   2                      DPWM =0;
 228   2                      PWM=1;
 229   2              }
 230   1              if(count == 36)//超声波回声脉宽最多18ms
 231   1              {
 232   2                      
 233   2                      TR0 =0;
 234   2                      TL0 = 0xcd;
 235   2                      TH0 = 0xf8;
 236   2                      count = 0;
 237   2              }
 238   1      }
 239          /******************************************************************************/
 240          
 241          
C51 COMPILER V9.03   MCU_TEST                                                              05/20/2015 17:32:41 PAGE 5   

 242          
 243          
 244          
 245          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    633    ----
   CONSTANT SIZE    =     14    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     35       8
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
